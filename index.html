<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>barcode_like_link_gen（hash 版本测试）</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", sans-serif; margin: 2rem auto; max-width: 880px; padding: 0 1rem; }
    h1 { font-weight: 600; font-size: 1.4rem; margin: 0 0 1rem; }
    section { border: 1px solid #9993; border-radius: 10px; padding: 1rem; margin: 1rem 0; }
    label { display: block; margin: .3rem 0 .4rem; font-weight: 600; }
    input[type="url"], input[type="text"] { width: 100%; padding: .6rem .7rem; border: 1px solid #9996; border-radius: 8px; font-size: .95rem; box-sizing: border-box; }
    button { margin-top: .6rem; padding: .6rem .9rem; border-radius: 8px; border: 1px solid #9996; background: #eee; cursor: pointer; }
    a.long { word-break: break-all; }
    .note { color: #888; font-size: .9rem; }
    .err { color: #c00; font-weight: 600; }
    .ok { color: #1a7f37; font-weight: 600; }
  </style>
</head>
<body>
  <h1>barcode_like_link_gen（hash 版本测试页）</h1>

  <section id="encode">
    <label for="srcUrl">原始链接（将被编码到 #hash 中）</label>
    <input id="srcUrl" type="url" placeholder="例如：https://example.com/path?x=1#y" autocomplete="off" spellcheck="false">
    <div class="row" style="display:grid;grid-template-columns:1fr auto;align-items:center;gap:.6rem;">
      <button id="btnGen">生成长链接</button>
      <span class="note">输出示例：<code>https://.../barcode_like_link_gen/#lIIlI...</code></span>
    </div>
    <div id="genOut"></div>
  </section>

  <section id="decode">
    <label for="longLink">长链接（或直接粘贴 l/I 编码串）</label>
    <input id="longLink" type="text" placeholder="https://rogerma12345.github.io/barcode_like_link_gen/#lIIlI... 或 lIIlI...">
    <div class="row" style="display:grid;grid-template-columns:1fr auto;align-items:center;gap:.6rem;">
      <button id="btnDec">解码回原链接</button>
      <span class="note">也支持直接访问长链接自动解码并重定向</span>
    </div>
    <div id="decOut"></div>
  </section>

  <script>
    const MAP0 = 'l';    // 0 -> 小写 L
    const MAP1 = 'I';    // 1 -> 大写 I

    // 字节序列 -> l/I 字符串
    function bytesToIi(bytes) {
      let bits = '';
      for (const b of bytes) bits += b.toString(2).padStart(8, '0');
      return bits.replace(/0/g, MAP0).replace(/1/g, MAP1);
    }
    // l/I 字符串 -> 字节序列
    function iiToBytes(ii) {
      const bits = ii.trim().replace(/[^lI]/g, '').replaceAll(MAP0, '0').replaceAll(MAP1, '1');
      if (!bits) throw new Error('缺少有效的 l/I 数据');
      if (bits.length % 8 !== 0) throw new Error('bit 长度不是 8 的倍数');
      const bytes = bits.match(/.{8}/g).map(b => parseInt(b, 2));
      return new Uint8Array(bytes);
    }

    const enc = new TextEncoder();
    const dec = new TextDecoder('utf-8');

    function textToIi(s) { return bytesToIi(enc.encode(s)); }
    function iiToText(ii) { return dec.decode(iiToBytes(ii)); }

    // 仅把 { u: 原始链接, t: 时间戳 } 放入 JSON
    function buildPayload(url) {
      return JSON.stringify({ u: url, t: Date.now() });
    }
    function parsePayload(json) {
      const obj = JSON.parse(json);
      if (!obj || typeof obj !== 'object' || typeof obj.u !== 'string') {
        throw new Error('payload 缺少 u 字段');
      }
      return obj;
    }

    // 生成基地址（保证以 / 结尾），适配本地与 GitHub Pages
    function baseUrl() {
      const p = location.pathname.replace(/index\.html?$/i, '');
      return location.origin + p;
    }

    // 生成长链接
    const $srcUrl = document.getElementById('srcUrl');
    const $btnGen = document.getElementById('btnGen');
    const $genOut = document.getElementById('genOut');

    $btnGen.addEventListener('click', () => {
      $genOut.textContent = '';
      try {
        const url = $srcUrl.value.trim();
        if (!/^https?:\/\//i.test(url)) throw new Error('请输入以 http/https 开头的绝对链接');
        const longLink = baseUrl() + '#' + textToIi(buildPayload(url));
        const a = document.createElement('a');
        a.className = 'long';
        a.href = longLink;
        a.textContent = longLink;
        a.rel = 'noopener';
        $genOut.innerHTML = '';
        $genOut.appendChild(a);
      } catch (e) {
        $genOut.innerHTML = '<span class="err">生成失败：' + (e && e.message || e) + '</span>';
      }
    });

    // 解码长链接（或纯 l/I 串）
    const $longLink = document.getElementById('longLink');
    const $btnDec = document.getElementById('btnDec');
    const $decOut = document.getElementById('decOut');

    $btnDec.addEventListener('click', () => {
      $decOut.textContent = '';
      try {
        let raw = $longLink.value.trim();
        if (!raw) throw new Error('请输入长链接或 l/I 串');
        const hashMatch = raw.match(/#(.+)$/);
        const ii = hashMatch ? decodeURIComponent(hashMatch[1]) : raw;
        const { u } = parsePayload(iiToText(ii));
        const a = document.createElement('a');
        a.href = u; a.textContent = u; a.rel = 'noopener'; a.target = '_blank';
        $decOut.innerHTML = '<span class="ok">解码成功：</span>';
        $decOut.appendChild(a);
      } catch (e) {
        $decOut.innerHTML = '<span class="err">解码失败：' + (e && e.message || e) + '</span>';
      }
    });

    // 访问长链接时自动解码并跳转
    (function autoRedirectIfHash() {
      const h = location.hash;
      if (!h || h.length <= 1) return;
      try {
        const ii = decodeURIComponent(h.slice(1));
        const { u } = parsePayload(iiToText(ii));
        location.replace(u); // 不保留中间页历史记录
      } catch (e) {
        console.error(e);
        const err = document.createElement('div');
        err.className = 'err';
        err.textContent = '自动解码失败：' + (e && e.message || e);
        document.body.prepend(err);
      }
    })();
  </script>
</body>
</html>
